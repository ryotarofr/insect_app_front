<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excalidraw Sample</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        #controls {
            padding: 15px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        #app {
            height: calc(100vh - 60px);
        }
    </style>
</head>
<body>
    <div id="controls">
        <button onclick="addRectangle()">四角形を追加</button>
        <button onclick="addCircle()">円を追加</button>
        <button onclick="addArrow()">矢印を追加</button>
        <button onclick="clearCanvas()">クリア</button>
        <button onclick="exportToJSON()">JSONエクスポート</button>
        <button onclick="saveAsPNG()">PNG保存</button>
    </div>
    <div id="app"></div>

    <script type="module">
        import { Excalidraw } from "https://esm.sh/@excalidraw/excalidraw@0.18.0";
        import React from "https://esm.sh/react@18";
        import ReactDOM from "https://esm.sh/react-dom@18/client";

        let excalidrawAPI;

        const initialData = {
            elements: [
                {
                    type: "rectangle",
                    x: 50,
                    y: 50,
                    width: 200,
                    height: 100,
                    strokeColor: "#000000",
                    backgroundColor: "#ffc9c9",
                    fillStyle: "hachure",
                    strokeWidth: 2,
                    roughness: 1,
                    opacity: 100,
                    roundness: { type: 3 },
                },
                {
                    type: "ellipse",
                    x: 300,
                    y: 50,
                    width: 150,
                    height: 150,
                    strokeColor: "#000000",
                    backgroundColor: "#a3d4ff",
                    fillStyle: "cross-hatch",
                    strokeWidth: 2,
                    roughness: 1,
                    opacity: 100,
                },
                {
                    type: "text",
                    x: 70,
                    y: 80,
                    width: 160,
                    height: 40,
                    fontSize: 20,
                    fontFamily: 1,
                    text: "Excalidraw\nサンプル",
                    strokeColor: "#000000",
                    backgroundColor: "transparent",
                    fillStyle: "hachure",
                    strokeWidth: 2,
                    roughness: 1,
                    opacity: 100,
                },
            ],
            appState: {
                viewBackgroundColor: "#ffffff",
            },
        };

        const App = () => {
            return React.createElement(Excalidraw, {
                initialData: initialData,
                excalidrawAPI: (api) => {
                    excalidrawAPI = api;
                },
                onChange: (elements, appState) => {
                    console.log("要素が変更されました:", elements.length, "個");
                },
            });
        };

        const root = ReactDOM.createRoot(document.getElementById("app"));
        root.render(React.createElement(App));

        // グローバル関数
        window.addRectangle = () => {
            if (!excalidrawAPI) return;
            const newElement = {
                type: "rectangle",
                x: Math.random() * 400,
                y: Math.random() * 300,
                width: 150,
                height: 100,
                strokeColor: "#000000",
                backgroundColor: `#${Math.floor(Math.random()*16777215).toString(16)}`,
                fillStyle: "hachure",
                strokeWidth: 2,
                roughness: 1,
                opacity: 100,
                roundness: { type: 3 },
            };
            excalidrawAPI.updateScene({
                elements: [...excalidrawAPI.getSceneElements(), newElement],
            });
        };

        window.addCircle = () => {
            if (!excalidrawAPI) return;
            const newElement = {
                type: "ellipse",
                x: Math.random() * 400,
                y: Math.random() * 300,
                width: 100,
                height: 100,
                strokeColor: "#000000",
                backgroundColor: `#${Math.floor(Math.random()*16777215).toString(16)}`,
                fillStyle: "solid",
                strokeWidth: 2,
                roughness: 1,
                opacity: 100,
            };
            excalidrawAPI.updateScene({
                elements: [...excalidrawAPI.getSceneElements(), newElement],
            });
        };

        window.addArrow = () => {
            if (!excalidrawAPI) return;
            const startX = Math.random() * 400;
            const startY = Math.random() * 300;
            const newElement = {
                type: "arrow",
                x: startX,
                y: startY,
                width: 150,
                height: 0,
                strokeColor: "#000000",
                backgroundColor: "transparent",
                fillStyle: "hachure",
                strokeWidth: 2,
                roughness: 1,
                opacity: 100,
                points: [[0, 0], [150, 100]],
            };
            excalidrawAPI.updateScene({
                elements: [...excalidrawAPI.getSceneElements(), newElement],
            });
        };

        window.clearCanvas = () => {
            if (!excalidrawAPI) return;
            excalidrawAPI.resetScene();
        };

        window.exportToJSON = () => {
            if (!excalidrawAPI) return;
            const elements = excalidrawAPI.getSceneElements();
            const appState = excalidrawAPI.getAppState();
            const data = { elements, appState };
            console.log("エクスポートデータ:", data);

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'excalidraw-export.json';
            link.click();
        };

        window.saveAsPNG = async () => {
            if (!excalidrawAPI) return;
            const elements = excalidrawAPI.getSceneElements();
            const appState = excalidrawAPI.getAppState();

            // 簡易的な保存（実際にはExcalidrawのexportToCanvasを使用）
            alert("PNG保存機能は開発中です。コンソールを確認してください。");
            console.log("保存するデータ:", { elements, appState });
        };
    </script>
</body>
</html>
